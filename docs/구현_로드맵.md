# 전체 시스템 구현 로드맵

> XReal Air2 Ultra + Beam Pro 하이브리드 실내 내비게이션 실험 시스템의 Unity 앱 설계 및 구현 계획.

---

## 1. Unity 앱 아키텍처

### 1.1 프로젝트 구조

```
ARNavExperiment/
├── Assets/
│   ├── Scripts/
│   │   ├── Core/                    # 핵심 매니저
│   │   │   ├── ExperimentManager.cs     # 실험 전체 흐름 제어
│   │   │   ├── ConditionController.cs   # 기기 조건 (G/H) 전환
│   │   │   └── ParticipantSession.cs    # 참가자 세션 정보 관리
│   │   │
│   │   ├── Mission/                 # 미션 시스템
│   │   │   ├── MissionManager.cs        # 미션 진행 상태 관리
│   │   │   ├── MissionData.cs           # 미션 ScriptableObject 정의
│   │   │   ├── MissionBriefingUI.cs     # 미션 브리핑 표시
│   │   │   └── VerificationUI.cs        # 검증 질문 UI
│   │   │
│   │   ├── Navigation/              # 내비게이션
│   │   │   ├── WaypointManager.cs       # 웨이포인트 시퀀스 관리
│   │   │   ├── ARArrowRenderer.cs       # AR 화살표 렌더링
│   │   │   └── TriggerController.cs     # 불확실성 트리거 4종
│   │   │
│   │   ├── BeamPro/                 # Beam Pro 정보 허브 (v2.1)
│   │   │   ├── BeamProHubController.cs  # 정보 허브 전체 제어 (3-레이어 관리)
│   │   │   ├── InteractiveMapController.cs # Layer 1: 인터랙티브 맵 + POI 마커
│   │   │   ├── POIDetailPanel.cs        # POI 상세 정보 패널
│   │   │   ├── InfoCardManager.cs       # Layer 2: 상황 정보 카드 관리
│   │   │   ├── ComparisonCardUI.cs      # 비교 카드 UI (미션 C용)
│   │   │   ├── MissionRefPanel.cs       # Layer 3: 미션 참조 패널
│   │   │   └── BeamProEventLogger.cs    # 정보 허브 이벤트 로깅 (7종)
│   │   │
│   │   ├── Logging/                 # 데이터 수집
│   │   │   ├── EventLogger.cs           # 이벤트 CSV 로거 (스레드 안전)
│   │   │   ├── HeadTracker.cs           # 글래스 머리 회전 추적
│   │   │   └── DeviceStateTracker.cs    # Beam Pro 화면 ON/OFF 감지
│   │   │
│   │   ├── UI/                      # 공통 UI
│   │   │   ├── ConfidenceRatingUI.cs    # 확신도 입력 (1-7)
│   │   │   ├── DifficultyRatingUI.cs    # 난이도 평정 UI
│   │   │   └── ExperimentHUD.cs         # 실험 상태 표시
│   │   │
│   │   └── Utils/                   # 유틸리티
│   │       ├── CounterbalanceConfig.cs  # 역균형 배정 설정
│   │       └── CSVWriter.cs             # CSV 파일 쓰기 유틸리티
│   │
│   ├── Data/
│   │   ├── Routes/                  # 경로 데이터 (ScriptableObject)
│   │   │   ├── RouteA.asset
│   │   │   └── RouteB.asset
│   │   ├── Missions/                # 미션 데이터
│   │   │   ├── RouteA_Missions.asset
│   │   │   └── RouteB_Missions.asset
│   │   └── Config/
│   │       └── ExperimentConfig.asset   # 실험 설정 (참가자 수, 트리거 등)
│   │
│   ├── Prefabs/
│   │   ├── ARArrow.prefab           # AR 방향 화살표
│   │   ├── WaypointMarker.prefab    # 웨이포인트 마커
│   │   ├── TriggerZone.prefab       # 트리거 영역
│   │   └── UI/
│   │       ├── MissionBriefingPanel.prefab
│   │       ├── VerificationPanel.prefab
│   │       └── ConfidencePanel.prefab
│   │
│   ├── Scenes/
│   │   ├── MainExperiment.unity     # 메인 실험 씬
│   │   ├── PracticeRoute.unity      # 연습 경로 씬
│   │   └── Setup.unity              # 실험자 설정 화면
│   │
│   └── Plugins/
│       └── XREALSdk/               # XREAL SDK 3.1.0 (Air2 Ultra + Beam Pro)
│
├── Packages/
└── ProjectSettings/
```

### 1.2 핵심 스크립트 설계

#### ExperimentManager.cs — 실험 전체 흐름

```
상태 머신:
  IDLE → SETUP → PRACTICE → CONDITION_1 → SURVEY_1 →
  CONDITION_2 → SURVEY_2 → POST_SURVEY → COMPLETE
```

- 싱글톤 패턴, 씬 전환 관리
- `ParticipantSession`에서 참가자 ID, 순서 그룹 로드
- 각 상태 전환 시 `EventLogger`에 제어 이벤트 기록
- 실험자 원격 제어 UI (다음 단계 진행, 긴급 중지)

#### MissionManager.cs — 미션 진행 관리

```
미션 생명주기:
  BRIEFING → NAVIGATION → ARRIVAL → VERIFICATION → SCORED
```

- 경로 데이터에 연결된 미션 목록 순차 실행
- 미션 타입(A/B/C)별 분기 처리
- 검증 질문 정답 판정 및 로깅
- 미션 완료 후 난이도 평정 UI 표시

#### ConditionController.cs — 기기 조건 제어

| 조건 | Glass 출력 | Beam Pro 출력 |
|------|-----------|--------------|
| Glass Only | AR 화살표 | 화면 잠금 |
| Hybrid | AR 화살표 | 대기 (들면 **정보 허브** 활성화: 인터랙티브 맵 + POI + 정보 카드) |

- 조건 전환 시 글래스/Beam Pro 디스플레이 모드 자동 설정
- Hybrid 조건: `DeviceStateTracker`의 lift-to-wake 이벤트와 연동

---

## 2. XREAL SDK 연동

> **SDK 변경**: 기존 NRSDK 2.2.x → **XREAL SDK 3.1.0** (Unity XR 생태계 통합, 2025년 리아키텍처)

### 2.1 하드웨어 구성

```
┌─────────────────┐    USB-C    ┌──────────────────┐
│ XReal Air2 Ultra│◄───────────►│ XReal Beam Pro   │
│  (디스플레이)    │  미러링/확장  │  (Android 연산)   │
│  - AR 화살표     │             │  - Unity 앱 실행  │
│  - 머리 추적     │             │  - 2D 지도 표시   │
└─────────────────┘             │  - 이벤트 로깅    │
                                └──────────────────┘
```

### 2.2 듀얼 출력 구조

- **Beam Pro 화면**: Unity 메인 카메라 렌더링 (2D 지도, UI)
- **글래스 화면**: XREAL SDK의 XR 렌더링 파이프라인을 통한 AR 오버레이 (화살표, HUD)
- 두 화면은 독립적 렌더링이지만 동일 Unity 앱에서 관리
- XREAL SDK의 세션 관리로 글래스 연결 상태 모니터링

### 2.3 핵심 API 활용

| 기능 | XREAL SDK 3.x API |
|------|--------------------|
| 머리 추적 | Unity XR Input → `InputDevice.TryGetFeatureValue(CommonUsages.deviceRotation)` |
| AR 디스플레이 | XR Plugin Management → XREAL XR Provider |
| 공간 앵커 | AR Foundation `ARAnchorManager` → XREAL Anchor Provider |
| 이미지 추적 | AR Foundation `ARTrackedImageManager` — QR 코드 기반 위치 보정 |

### 2.4 필수 Unity 패키지

| 패키지 | 버전 | 용도 |
|--------|------|------|
| XR Plugin Management | 4.4.0+ | XR 런타임 관리 |
| XR Interaction Toolkit | 2.5.x | XR 입력/인터랙션 |
| AR Foundation | 5.1.x | AR 기능 추상화 |
| Input System | 1.7.0+ | 새 입력 시스템 |
| TextMeshPro | 3.0.6+ | 한국어 UI 텍스트 |

---

## 3. AR 화살표 렌더링

### 3.1 화살표 방향 계산

```
현재 위치(P) → 다음 웨이포인트(W)까지의 방향 벡터:
  direction = normalize(W.position - P.position)
  yaw = atan2(direction.x, direction.z) * Rad2Deg

화살표 회전:
  arrow.rotation = Quaternion.Euler(0, yaw, 0)
```

- 웨이포인트 반경(2m) 진입 시 자동으로 다음 웨이포인트로 전환
- 화살표는 참가자 시야 하단 중앙에 고정 (world-locked이 아닌 view-locked)

### 3.2 트리거 적용

| 트리거 | 화살표 변화 |
|--------|-----------|
| T1 (안내 열화) | 5-8초 떨림(±5° 랜덤 진동) → 완전 소실 → 2-5초 후 복구 |
| T2 (정보 불일치) | 정상 표시 (환경 표지판과의 불일치는 물리적 배치로 구현) |
| T3 (해상도 부족) | 화살표 끝이 부채꼴(±30°)로 퍼지며 반투명 처리 |
| T4 (안내 부재) | "목적지 근처입니다" 텍스트만 표시, 화살표 제거 |

### 3.3 화살표 시각 디자인

- 크기: 시야 내 높이 약 2cm (거리감 고려)
- 색상: 기본 파란색(#3498db), 트리거 시 주황색(#e67e22) 점멸
- 애니메이션: 부드러운 방향 보간 (Slerp, 0.3초)

---

## 4. Beam Pro 정보 허브 (Information Companion)

> v2.1에서 "2D 맵 디스플레이"를 **3-레이어 정보 허브**로 전면 재설계.
> 글래스(WHERE to go) + Beam Pro(WHAT to know) 역할 분리 원칙.

### 4.1 3-레이어 UI 구조

```
┌──────────────────────────────────┐
│  [맵] [정보 카드] [미션 참조]        │  ← 탭 바 (Layer 전환)
├──────────────────────────────────┤
│                                  │
│  ┌─ Layer 1: 인터랙티브 맵 ─────┐  │
│  │       단일 층 평면도           │  │
│  │   ──┬──┬──────┬──           │  │
│  │     │  │      │             │  │
│  │   ──┤  │  ★   │  ← 목적지   │  │
│  │     │☕│      │             │  │
│  │   ──┤  │  🚻  ├──           │  │
│  │     │  ●→     │  ← 현재 위치 │  │
│  │   ──┴──┴──────┴──           │  │
│  │  ☕ 자판기  🚻 화장실  ★ 목적지 │  │  ← POI 마커
│  └────────────────────────────┘  │
│                                  │
│  ┌─ Layer 2: 상황 정보 카드 ────┐  │  ← 자동/수동 표시
│  │  📋 회의실 302 상세            │  │
│  │  수용인원: 30명 | 장비: 빔프로젝터│  │
│  │  면적: 42㎡ | 위치: 중앙동 3층  │  │
│  └────────────────────────────┘  │
│                                  │
│  [미션: 30인 이상 회의실 찾기]       │  ← 미션 바
│  확신도: ●●●●●○○ (5/7)           │
└──────────────────────────────────┘
```

### 4.2 Layer 1: InteractiveMapController

- 건물 평면도 이미지 위에 경로 오버레이
- **POI 마커 시스템**: 회의실, 자판기, 화장실, 비상구 등 마커 표시
  - 마커 탭 → `POIDetailPanel` 오버레이 표시
  - `BEAM_POI_VIEWED` 이벤트 로깅
- 현재 웨이포인트 기반 자동 줌 + 수동 확대/축소 제스처
  - `BEAM_MAP_ZOOMED` 이벤트 로깅
- 현재 위치 마커 (웨이포인트 기반 추정)
- 다음 목적지 핀

### 4.3 Layer 2: InfoCardManager

- **자동 표시 (Push)**: 현재 위치/미션 맥락에 따라 관련 정보 카드 자동 팝업
  - `auto_shown: true` 플래그로 자동/수동 구분 로깅
- **수동 열기 (Pull)**: 사용자가 관련 정보 카드를 직접 탭하여 열기
- **카드 유형**:
  - POI Detail Card: 방 상세 (수용인원, 장비, 호실번호)
  - Sign/Poster Card: 멀리 있는 안내판/포스터의 고해상도 텍스트
  - Comparison Card (`ComparisonCardUI`): 미션 C의 비교 대상 속성 비교 표
  - Landmark Card: 주변 랜드마크 설명
- 이벤트: `BEAM_INFO_CARD_OPENED`, `BEAM_INFO_CARD_CLOSED`, `BEAM_COMPARISON_VIEWED`

### 4.4 Layer 3: MissionRefPanel

- 미션 브리핑 재열람 가능
- 미션 타입별 보조 정보:
  - A: 목적지 POI 힌트
  - B: 주변 지도 정보
  - C: 비교 속성 목록
- 이벤트: `BEAM_MISSION_REF_VIEWED`

### 4.5 Lift-to-Wake 감지

- Beam Pro의 가속도계/자이로 활용
- 기기를 들어올리는 동작 감지 → 정보 허브 활성화
- `DeviceStateTracker`에서 `BEAM_SCREEN_ON` 이벤트 발생
- 내려놓거나 5초간 움직임 없으면 → `BEAM_SCREEN_OFF`
- 탭 전환 시 `BEAM_TAB_SWITCH` 이벤트 발생

### 4.6 조건별 정보 허브 동작

| 조건 | Beam Pro 화면 |
|------|-------------|
| Glass Only | 화면 잠금 (검은 화면 + "이 조건에서는 사용 불가" 메시지) |
| Hybrid | 대기 모드 → lift-to-wake로 정보 허브 활성화 |

---

## 5. 미션 시스템

### 5.1 미션 데이터 구조 (ScriptableObject)

```csharp
[CreateAssetMenu(fileName = "Mission", menuName = "Experiment/Mission")]
public class MissionData : ScriptableObject
{
    public string missionId;           // "A1", "B2", "C1" 등
    public MissionType type;           // A, B, C
    public string briefingText;        // 미션 브리핑 문구
    public string targetWaypointId;    // 목적지 웨이포인트
    public string verificationQuestion; // 검증 질문
    public string[] answerOptions;     // 선택지 (4지선다)
    public int correctAnswerIndex;     // 정답 인덱스
    public string associatedTriggerId; // 연관 트리거 (있을 경우)

    // v2.1: Beam Pro 정보 허브 관련 필드
    public POIData[] relevantPOIs;         // 관련 POI 목록
    public InfoCardData[] infoCards;       // 관련 정보 카드 목록
    public ComparisonData comparisonData;  // 비교 데이터 (미션 C용, nullable)
    public Sprite[] referenceImages;       // 미션 참조 이미지
}

public enum MissionType { A_DirectionVerify, B_AmbiguousDecision, C_InfoIntegration }

// v2.1: POI 데이터 ScriptableObject
[CreateAssetMenu(fileName = "POI", menuName = "Experiment/POIData")]
public class POIData : ScriptableObject
{
    public string poiId;               // "room_302", "vending_01" 등
    public string poiType;             // "meeting_room", "vending_machine", "restroom", "emergency_exit"
    public string displayName;         // "회의실 302"
    public string description;         // 상세 설명
    public int capacity;               // 수용인원 (해당 시)
    public string[] equipment;         // 장비 목록 ("빔프로젝터", "화이트보드" 등)
    public Vector2 mapPosition;        // 평면도 위 좌표
    public Sprite icon;                // 마커 아이콘
}

// v2.1: 정보 카드 데이터 ScriptableObject
[CreateAssetMenu(fileName = "InfoCard", menuName = "Experiment/InfoCardData")]
public class InfoCardData : ScriptableObject
{
    public string cardId;              // "card_01"
    public string cardType;            // "poi_detail", "sign_card", "comparison", "landmark"
    public string title;               // 카드 제목
    public string content;             // 카드 본문
    public Sprite image;               // 카드 이미지 (선택)
    public string triggerWaypointId;   // 자동 표시 트리거 웨이포인트
    public bool autoShow;              // 자동 표시 여부
}

// v2.1: 비교 데이터 (미션 C용)
[System.Serializable]
public class ComparisonData
{
    public string comparisonId;        // "comp_01"
    public string[] itemNames;         // 비교 대상 이름 배열
    public string[] attributes;        // 비교 속성 이름 배열
    public string[,] values;           // 속성 값 매트릭스
}
```

### 5.2 경로 A MissionData 인스턴스

> KIT 디지털관 지하1층 경로 A (서쪽-북쪽 루프) 기준

```csharp
// === Route A: Mission A1 ===
var missionA1 = new MissionData {
    missionId = "A1",
    type = MissionType.A_DirectionVerify,
    briefingText = "이 층에서 가장 큰 강의실(대강의실)을 찾아가세요. 도착 후 해당 강의실의 호실 번호를 확인하세요.",
    targetWaypointId = "WP02",
    verificationQuestion = "방금 도착한 강의실의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B124", "B125", "B126", "B127" },
    correctAnswerIndex = 1,
    associatedTriggerId = null
};

// === Route A: Mission B1 (T1 트리거) ===
var missionB1 = new MissionData {
    missionId = "B1",
    type = MissionType.B_AmbiguousDecision,
    briefingText = "시청각 장비가 갖춰진 공간을 찾아가세요.",
    targetWaypointId = "WP03",
    verificationQuestion = "도착한 공간의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B125", "B126", "B127", "B128" },
    correctAnswerIndex = 2,
    associatedTriggerId = "T1"
};

// === Route A: Mission A2 ===
var missionA2 = new MissionData {
    missionId = "A2",
    type = MissionType.A_DirectionVerify,
    briefingText = "대학원 전용 강의실을 찾아가세요. 도착 후 강의실 문의 호실 번호를 확인하세요.",
    targetWaypointId = "WP05",
    verificationQuestion = "방금 도착한 대학원 강의실의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B128", "B129", "B130", "B131" },
    correctAnswerIndex = 2,
    associatedTriggerId = null
};

// === Route A: Mission B2 (T4 트리거) ===
var missionB2 = new MissionData {
    missionId = "B2",
    type = MissionType.B_AmbiguousDecision,
    briefingText = "세미나실을 찾아가세요.",
    targetWaypointId = "WP06",
    verificationQuestion = "도착한 세미나실의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B131", "B132", "B133", "B134" },
    correctAnswerIndex = 2,
    associatedTriggerId = "T4"
};

// === Route A: Mission C1 ===
var missionC1 = new MissionData {
    missionId = "C1",
    type = MissionType.C_InfoIntegration,
    briefingText = "B132 강의실과 B133 세미나실을 각각 확인하세요. 10명 이하 소규모 그룹 토론에 더 적합한 공간의 호실 번호를 선택하세요.",
    targetWaypointId = "WP08",
    verificationQuestion = "소규모 그룹 토론에 더 적합한 공간은?",
    answerOptions = new[] { "B132 (강의실)", "B133 (세미나실)", "둘 다 적합", "둘 다 부적합" },
    correctAnswerIndex = 1,
    associatedTriggerId = null
};
```

### 5.3 경로 B MissionData 인스턴스

> KIT 디지털관 지하1층 경로 B (동쪽-북쪽 루프) 기준

```csharp
// === Route B: Mission A1 ===
var missionA1 = new MissionData {
    missionId = "A1",
    type = MissionType.A_DirectionVerify,
    briefingText = "이 층의 실습실 또는 연구실 중 하나를 찾아가세요. 도착 후 해당 공간의 호실 번호를 확인하세요.",
    targetWaypointId = "WP02",
    verificationQuestion = "방금 도착한 공간의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B115", "B116", "B117", "B118" },
    correctAnswerIndex = 1,
    associatedTriggerId = null
};

// === Route B: Mission B1 (T2 트리거) ===
var missionB1 = new MissionData {
    missionId = "B1",
    type = MissionType.B_AmbiguousDecision,
    briefingText = "교수 연구실이 있는 방향으로 이동하세요.",
    targetWaypointId = "WP03",
    verificationQuestion = "이동한 방향에서 처음 만난 교수실의 호실 번호는?",
    answerOptions = new[] { "B108", "B109", "B110", "B111" },
    correctAnswerIndex = 2,  // 현장 확인 후 확정
    associatedTriggerId = "T2"
};

// === Route B: Mission A2 ===
var missionA2 = new MissionData {
    missionId = "A2",
    type = MissionType.A_DirectionVerify,
    briefingText = "지능 관련 연구를 수행하는 연구실을 찾아가세요. 도착 후 호실 번호를 확인하세요.",
    targetWaypointId = "WP05",
    verificationQuestion = "방금 도착한 연구실의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B106", "B107", "B108", "B109" },
    correctAnswerIndex = 1,
    associatedTriggerId = null
};

// === Route B: Mission B2 (T3 트리거) ===
var missionB2 = new MissionData {
    missionId = "B2",
    type = MissionType.B_AmbiguousDecision,
    briefingText = "이 교차로 근처의 교수실을 찾아가세요.",
    targetWaypointId = "WP06",
    verificationQuestion = "도착한 교수실의 호실 번호는 무엇입니까?",
    answerOptions = new[] { "B101", "B102", "B103", "B104" },
    correctAnswerIndex = 0,
    associatedTriggerId = "T3"
};

// === Route B: Mission C1 ===
var missionC1 = new MissionData {
    missionId = "C1",
    type = MissionType.C_InfoIntegration,
    briefingText = "B104 교수실과 B105 교수실을 각각 확인하세요. 두 교수실 중 문 앞 안내판에 연구실 정보가 더 상세하게 게시된 쪽의 호실 번호를 선택하세요.",
    targetWaypointId = "WP08",
    verificationQuestion = "안내판 정보가 더 상세한 교수실은?",
    answerOptions = new[] { "B104", "B105", "둘 다 동일", "둘 다 없음" },
    correctAnswerIndex = 0,  // 현장 확인 후 확정
    associatedTriggerId = null
};
```

### 5.4 POIData 인스턴스

#### 경로 A POI (11개)

```csharp
var routeA_POIs = new POIData[] {
    new POIData {
        poiId = "room_b123", poiType = "lecture_room",
        displayName = "B123 강의실", description = "남쪽복도 강의실",
        capacity = 0, equipment = new string[] { }, // 현장 확인 후 확정
        mapPosition = new Vector2(0, 0) // 평면도 좌표 매핑 필요
    },
    new POIData {
        poiId = "room_b125", poiType = "large_lecture",
        displayName = "B125 대강의실", description = "대강의실 — 가장 큰 강의 공간",
        capacity = 0, equipment = new string[] { "빔프로젝터", "음향시스템" }, // 실측 필요
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b127", poiType = "av_room",
        displayName = "B127 시청각실", description = "시청각 장비 갖춘 다목적 공간",
        capacity = 0, equipment = new string[] { "스크린", "시청각 장비" },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b128", poiType = "counseling",
        displayName = "B128 학생상담실", description = "학생 상담 공간",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b129", poiType = "grad_lecture",
        displayName = "B129 대학원강의실", description = "대학원 전용 강의실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b130", poiType = "grad_lecture",
        displayName = "B130 대학원강의실", description = "대학원 전용 강의실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b131", poiType = "lecture_room",
        displayName = "B131 강의실", description = "서쪽복도 상단 강의실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b132", poiType = "lecture_room",
        displayName = "B132 강의실", description = "북쪽복도 강의실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b133", poiType = "seminar_room",
        displayName = "B133 세미나실", description = "소규모 세미나/토론 공간",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "restroom_w", poiType = "restroom",
        displayName = "여자화장실", description = "B128 부근",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "stairs_main", poiType = "stairs",
        displayName = "중앙 계단", description = "남쪽 중앙 계단 (시작점)",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    }
};
```

#### 경로 B POI (10개)

```csharp
var routeB_POIs = new POIData[] {
    new POIData {
        poiId = "room_b121", poiType = "computer_lab",
        displayName = "B121 PC실습실", description = "PC 실습 공간",
        capacity = 0, equipment = new string[] { "PC" },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b116", poiType = "tbd",
        displayName = "B116", description = "현장 확인 후 확정",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b110", poiType = "tbd",
        displayName = "B110", description = "현장 확인 후 확정",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b107", poiType = "research_lab",
        displayName = "B107 전산지능연구실", description = "전산지능 분야 연구실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b106", poiType = "research_lab",
        displayName = "B106 지능공학연구실", description = "지능공학 분야 연구실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b104", poiType = "professor_office",
        displayName = "B104 최태훈 교수실", description = "교수 연구실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b105", poiType = "professor_office",
        displayName = "B105 송영민 교수실", description = "교수 연구실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b102", poiType = "research_lab",
        displayName = "B102 네트워크연구실", description = "네트워크 분야 연구실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "room_b101", poiType = "professor_office",
        displayName = "B101 이재민 교수실", description = "NE교차로 부근 교수실",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    },
    new POIData {
        poiId = "stairs_main", poiType = "stairs",
        displayName = "중앙 계단", description = "남쪽 중앙 계단 (시작점)",
        capacity = 0, equipment = new string[] { },
        mapPosition = new Vector2(0, 0)
    }
};
```

> **참고**: `capacity`, `equipment`, `mapPosition` 값은 현장 답사 및 평면도 디지타이징 후 확정.

### 5.5 InfoCardData / ComparisonData 인스턴스

#### 경로 A Info Cards (5개)

```csharp
var routeA_InfoCards = new InfoCardData[] {
    new InfoCardData {
        cardId = "a_card_01", cardType = "sign_card",
        title = "B125 대강의실 안내",
        content = "수용인원: TBD명 | 장비: 빔프로젝터, 음향시스템 | 용도: 대형 강의",
        triggerWaypointId = "WP02", autoShow = true
    },
    new InfoCardData {
        cardId = "a_card_02", cardType = "poi_detail",
        title = "SW교차로 주변 시설 안내",
        content = "좌측: B127 시청각실 | 우측: B125 대강의실 방면 | 직진: 서쪽복도(B128~B131)",
        triggerWaypointId = "WP03", autoShow = true
    },
    new InfoCardData {
        cardId = "a_card_03", cardType = "sign_card",
        title = "B130 대학원강의실 안내",
        content = "용도: 대학원 전용 강의 | 장비: TBD | 호실번호: B130",
        triggerWaypointId = "WP05", autoShow = true
    },
    new InfoCardData {
        cardId = "a_card_04", cardType = "landmark",
        title = "NW교차로 주변 시설",
        content = "좌측: B131 강의실 | 우측: B132 강의실, B133 세미나실 | 직진: 동쪽 방면",
        triggerWaypointId = "WP06", autoShow = true
    },
    new InfoCardData {
        cardId = "a_card_05", cardType = "comparison",
        title = "B132 vs B133 비교표",
        content = "", // ComparisonData로 별도 렌더링
        triggerWaypointId = "WP07", autoShow = true
    }
};

// 경로 A ComparisonData (Mission C1)
var routeA_Comparison = new ComparisonData {
    comparisonId = "comp_a_c1",
    itemNames = new[] { "B132 강의실", "B133 세미나실" },
    attributes = new[] { "수용인원", "좌석 배치", "장비", "용도" },
    values = new string[,] {
        { "TBD명", "TBD명" },           // 수용인원 — 현장 실측
        { "TBD", "TBD" },               // 좌석 배치
        { "TBD", "TBD" },               // 장비
        { "강의", "세미나/토론" }          // 용도
    }
};
```

#### 경로 B Info Cards (5개)

```csharp
var routeB_InfoCards = new InfoCardData[] {
    new InfoCardData {
        cardId = "b_card_01", cardType = "sign_card",
        title = "B116 안내",
        content = "용도: TBD (현장 확인 필요) | 호실번호: B116",
        triggerWaypointId = "WP02", autoShow = true
    },
    new InfoCardData {
        cardId = "b_card_02", cardType = "poi_detail",
        title = "E-T교차로 방향별 시설",
        content = "북쪽: B107~B101 (연구실/교수실) | 남쪽: B116~B121 (실습실) | 서쪽: 남쪽복도 방면",
        triggerWaypointId = "WP03", autoShow = true
    },
    new InfoCardData {
        cardId = "b_card_03", cardType = "sign_card",
        title = "B107 전산지능연구실 안내",
        content = "연구 분야: 전산지능 | 교수: TBD | 호실번호: B107",
        triggerWaypointId = "WP05", autoShow = true
    },
    new InfoCardData {
        cardId = "b_card_04", cardType = "landmark",
        title = "NE교차로 주변 시설",
        content = "좌측: B134 | 우측: B101 교수실 | 남쪽: B102~B107 연구실/교수실",
        triggerWaypointId = "WP06", autoShow = true
    },
    new InfoCardData {
        cardId = "b_card_05", cardType = "comparison",
        title = "B104 vs B105 비교표",
        content = "", // ComparisonData로 별도 렌더링
        triggerWaypointId = "WP07", autoShow = true
    }
};

// 경로 B ComparisonData (Mission C1)
var routeB_Comparison = new ComparisonData {
    comparisonId = "comp_b_c1",
    itemNames = new[] { "B104 최태훈 교수실", "B105 송영민 교수실" },
    attributes = new[] { "교수명", "전공", "연구실 위치", "연구분야" },
    values = new string[,] {
        { "최태훈", "송영민" },           // 교수명
        { "TBD", "TBD" },               // 전공
        { "TBD", "TBD" },               // 연구실 위치
        { "TBD", "TBD" }                // 연구분야
    }
};
```

> **참고**: `TBD` 값은 현장 답사 후 실측 데이터로 교체. `mapPosition`은 평면도 디지타이징 시 확정.

### 5.6 미션 UI 흐름

```
1. 미션 브리핑 팝업 (Glass + Beam Pro 동시 표시)
   ┌─────────────────────────┐
   │  📋 미션 #3              │
   │                         │
   │  30인 이상 수용 가능한    │
   │  회의실을 찾아가세요.     │
   │  도착 후 회의실 번호를    │
   │  보고하세요.             │
   │                         │
   │       [시작하기]          │
   └─────────────────────────┘

2. 내비게이션 수행 (기기 조건에 따라 화살표/지도 표시)

3. 도착 판정 (목적지 웨이포인트 반경 진입)

4. 검증 질문 UI
   ┌─────────────────────────┐
   │  회의실 번호는 무엇인가요? │
   │                         │
   │  ○ 301                  │
   │  ○ 302                  │
   │  ○ 303                  │
   │  ○ 304                  │
   │                         │
   │       [제출]              │
   └─────────────────────────┘

5. 확신도 + 난이도 평정

6. 다음 미션 또는 경로 종료
```

### 5.7 미션 타입별 검증 방식

| 타입 | 검증 시점 | 검증 방법 |
|------|----------|----------|
| A (방향+검증) | 목적지 도착 후 | 4지선다 질문 (환경 관찰 필요) |
| B (모호한 갈림길) | 갈림길 통과 후 | 올바른 방향 선택 여부 자동 판정 (웨이포인트 도달 순서) |
| C (정보 통합) | 정보 수집 완료 후 | 통합 판단 결과 4지선다 질문 |

---

## 6. 이벤트 로깅

### 6.1 확장된 CSV 스키마 (v2)

기존 스키마에 3개 컬럼 추가:

| 신규 컬럼 | 타입 | 설명 |
|-----------|------|------|
| `mission_id` | string | 현재 미션 ID (예: "A1", "B2") |
| `difficulty_rating` | int | 미션별 난이도 평정 (1-7) |
| `verification_correct` | bool | 검증 정답 여부 |

### 6.2 신규 이벤트 타입

| 이벤트 타입 | 설명 | extra_data |
|------------|------|------------|
| `MISSION_START` | 미션 시작 (브리핑 표시) | `{"mission_id": "A1", "type": "direction_verify"}` |
| `MISSION_ARRIVAL` | 미션 목적지 도달 | `{"mission_id": "A1"}` |
| `VERIFICATION_ANSWERED` | 검증 질문 응답 | `{"mission_id": "A1", "answer": 2, "correct": true, "rt_s": 4.3}` |
| `MISSION_COMPLETE` | 미션 완료 | `{"mission_id": "A1", "correct": true, "duration_s": 95}` |
| `TRIGGER_ACTIVATED` | 불확실성 트리거 활성화 | `{"trigger_type": "T1", "trigger_id": "route_a_t1"}` |
| `TRIGGER_DEACTIVATED` | 트리거 비활성화 (복구) | `{"trigger_type": "T1", "duration_s": 10.5}` |
| `DIFFICULTY_RATED` | 미션 난이도 평정 | `{"mission_id": "A1", "rating": 4}` |
| `BEAM_TAB_SWITCH` | 정보 허브 탭 전환 (v2.1) | `{"from_tab": "map", "to_tab": "info_card"}` |
| `BEAM_POI_VIEWED` | POI 상세 열람 (v2.1) | `{"poi_id": "room_302", "poi_type": "meeting_room", "view_duration_s": 3.5}` |
| `BEAM_INFO_CARD_OPENED` | 정보 카드 열림 (v2.1) | `{"card_id": "card_01", "card_type": "sign_card", "auto_shown": true}` |
| `BEAM_INFO_CARD_CLOSED` | 정보 카드 닫힘 (v2.1) | `{"card_id": "card_01", "view_duration_s": 5.2}` |
| `BEAM_MAP_ZOOMED` | 맵 줌 조작 (v2.1) | `{"zoom_level": 2.5}` |
| `BEAM_COMPARISON_VIEWED` | 비교 카드 열람 (v2.1) | `{"comparison_id": "comp_01", "items_compared": ["A", "B"]}` |
| `BEAM_MISSION_REF_VIEWED` | 미션 참조 열람 (v2.1) | `{"mission_id": "A1", "ref_type": "briefing_review"}` |

### 6.3 EventLogger 설계 (스레드 안전)

```csharp
public class EventLogger : MonoBehaviour
{
    private static EventLogger _instance;
    private StreamWriter _writer;
    private readonly object _lock = new object();
    private string _filePath;

    // 초기화: 참가자 ID, 조건, 경로로 파일명 생성
    public void Initialize(string participantId, string condition, string route)
    {
        string timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
        _filePath = $"{participantId}_{condition}_{route}_{timestamp}.csv";
        // CSV 헤더 쓰기
    }

    // 스레드 안전 이벤트 기록
    public void LogEvent(string eventType, string waypointId = "",
                         int confidenceRating = -1, string missionId = "",
                         int difficultyRating = -1, bool? verificationCorrect = null,
                         Dictionary<string, object> extraData = null)
    {
        lock (_lock)
        {
            // CSV 행 쓰기 + 즉시 flush
        }
    }
}
```

- `lock` 기반 스레드 안전 보장
- 각 이벤트 즉시 `Flush()` — 앱 크래시 시 데이터 손실 최소화
- 앱 종료 시 `OnDestroy()`에서 파일 정리

---

## 7. 데이터 파이프라인

### 7.1 전체 흐름

```
[Unity 앱]                [전처리]              [분석]
    │                        │                    │
    ├─ 이벤트 로그 CSV ──────►├─ 통합 CSV ────────►├─ analyze_device_switching.py
    │  (참가자별, 조건별)      │  all_events.csv    │  (전환 패턴, CVI)
    │                        │                    │
    ├─ 설문 데이터 ──────────►├─ 요약 통계 ────────►├─ analyze_trust_performance.py
    │  (NASA-TLX, 신뢰 등)    │  summary.csv       │  (신뢰, 확신도, calibration)
    │                        │                    │
    │                        │                    ├─ analyze_verification.py
    │                        │                    │  (미션 정확도, 검증 행동)
    │                        │                    │
    │                        │                    ├─ analyze_triggers.py
    │                        │                    │  (트리거별 반응)
    │                        │                    │
    │                        │                    └─► analysis/output/
    │                        │                        (CSV + PNG)
    │                        │
    └─ Beam Pro 내부 저장 ───►└─ USB로 PC 전송
```

### 7.2 전처리 단계

1. **파일 통합**: `data/raw/` 내 모든 개별 CSV를 `data/processed/all_events.csv`로 병합
2. **타임스탬프 정규화**: ISO 8601 파싱, 참가자별 상대 시간 계산
3. **세션 식별**: ROUTE_START ~ ROUTE_END 쌍으로 세션 경계 설정
4. **무결성 검사**: 이벤트 순서, 필수 필드, 웨이포인트 시퀀스 검증
5. **요약 테이블 생성**: 참가자 × 조건별 주요 지표 (완료시간, 정지 수, 미션 정확도 등)

---

## 8. 구현 타임라인

### Phase 1: 기반 구축 (1-2주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 1주차 | Unity 프로젝트 생성, NRSDK 통합, 기본 씬 구성 | 빈 프로젝트 + 글래스 연결 확인 |
| 2주차 | ExperimentManager 상태 머신, EventLogger, CSV 출력 | 기본 실험 흐름 + 로깅 동작 |

### Phase 2: 내비게이션 + Beam Pro 정보 허브 (3-5주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 3주차 | WaypointManager, ARArrowRenderer, 화살표 렌더링 | 기본 경로 추종 동작 |
| 4주차 | BeamProHubController, InteractiveMapController, POIDetailPanel | Beam Pro 정보 허브 Layer 1 동작 |
| 5주차 | InfoCardManager, ComparisonCardUI, MissionRefPanel, ConditionController | 정보 허브 Layer 2-3 + 2조건 전환 |

### Phase 3: 미션 시스템 (6-7주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 6주차 | MissionManager, MissionData (확장), 브리핑/검증 UI, POIData/InfoCardData 에셋 | 미션 A 타입 + 정보 허브 연동 |
| 7주차 | 미션 B/C 분기, TriggerController (4종), 난이도 평정, BeamProEventLogger | 전체 미션 시스템 + 정보 허브 이벤트 로깅 |

### Phase 4: 통합 및 테스트 (8-9주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 8주차 | 전체 통합, Lift-to-Wake, DeviceStateTracker, 정보 허브 인터랙션 테스트 | 완전한 실험 앱 |
| 9주차 | 현장 단일 층 경로 세팅, 웨이포인트/POI 배치, 정보 카드 콘텐츠 작성, 분석 스크립트 연동 테스트 | 현장 배포 버전 |

### Phase 5: 파일럿 및 본실험 (10-13주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 10주차 | 파일럿 테스트 (5명), 경로 난이도/정보 허브 콘텐츠 조정 | 파일럿 결과 보고서 |
| 11주차 | 파일럿 피드백 반영, 최종 수정 | 최종 실험 앱 |
| 12-13주차 | 본 실험 수행 (24명, 주 12명) | 원본 데이터 |

### Phase 6: 분석 (14-15주차)

| 주차 | 마일스톤 | 산출물 |
|------|---------|--------|
| 14주차 | 데이터 전처리, 1차 분석 (기술통계, 콘텐츠 접근 패턴) | 전처리 데이터 + 기술통계 |
| 15주차 | 추론통계, 시각화, 정보 활용도-정확도 상관 분석, 결과 해석 | 분석 결과 + 그래프 |

---

## 9. 기술적 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| 글래스 tracking loss (실제) | 트리거 T1과 구별 불가 | T1 트리거는 의도적 시각 효과로 구현, 실제 tracking loss는 별도 이벤트 로깅 |
| Beam Pro 배터리 소모 | 2조건 연속 수행 중 방전 | 조건 간 전환 시 충전 시간 확보, 배터리 잔량 모니터링 |
| 실내 위치 추정 오차 | 웨이포인트 도달 판정 부정확 | QR 코드 마커로 위치 보정, 웨이포인트 반경을 2m로 넉넉히 설정 |
| 미션 난이도 불균형 | 경로 간 비교 타당성 저하 | 파일럿 테스트로 정답률 확인 후 조정 |
| 참가자 55분 피로 | 가능성 낮음 | 2조건으로 축소되어 피로 리스크 대폭 감소, 역균형으로 순서 효과 통제 |

---

## 10. 개발 환경

| 항목 | 사양 |
|------|------|
| Unity 버전 | 2022.3.62f2 LTS |
| XREAL SDK 버전 | 3.1.0 (Air2 Ultra + Beam Pro 지원) |
| 타겟 플랫폼 | Android (Beam Pro) |
| 최소 API 레벨 | Android 12 (API 31) |
| 개발 언어 | C# |
| 분석 환경 | Python 3.10+, pandas, scipy, matplotlib, pingouin |
